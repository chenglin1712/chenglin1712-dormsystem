<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®¿èˆæ™šé»å</title>

    <link rel="manifest" href="/manifest.json" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 20px;
        background-color: #f2f2f7; /* iOS é¢¨æ ¼èƒŒæ™¯ç° */
        margin: 0;
      }
      .card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 40px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }
      h1 {
        color: #1c1c1e;
        margin-bottom: 5px;
        font-size: 1.8em;
      }
      .room {
        font-size: 2.5em;
        color: #007aff; /* iOS è— */
        font-weight: 800;
        margin: 10px 0;
        font-family: "SF Pro Display", sans-serif;
      }
      .btn {
        display: block;
        width: 100%;
        padding: 18px;
        font-size: 1.2em;
        font-weight: bold;
        color: white;
        background-color: #007aff;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        margin-top: 25px;
        box-shadow: 0 4px 6px rgba(0, 122, 255, 0.3);
        transition: transform 0.1s ease;
      }
      .btn:active {
        transform: scale(0.96);
      }
      .btn:disabled {
        background-color: #34c759; /* iOS ç¶  */
        box-shadow: none;
        cursor: default;
        transform: none;
      }
      .footer {
        margin-top: 30px;
        color: #8e8e93;
        font-size: 0.85em;
      }
      .status-text {
        margin-top: 15px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    {% if student %}
    <div class="card">
      <p
        style="
          color: #8e8e93;
          font-size: 0.9em;
          text-transform: uppercase;
          letter-spacing: 1px;
        "
      >
        æ™šé»åç³»çµ±
      </p>

      <div class="room">{{ student['room_number'] }}</div>

      <h1>{{ student['name'] }}</h1>

      <form method="POST" id="checkinForm">
        <input type="hidden" name="lat" id="lat" />
        <input type="hidden" name="lng" id="lng" />

        {% if error_msg %}
        <div
          style="
            background-color: #fff5f5;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
          "
        >
          {{ error_msg }}
        </div>
        {% endif %} {% if log and log['status'] == 'SUCCESS' %}
        <button class="btn" disabled>
          âœ… {{ log['checkin_time'].split(' ')[1][:5] }} å·²å®Œæˆ
        </button>
        <p class="status-text" style="color: #34c759">ä»Šæ—¥é»åæˆåŠŸ</p>

        {% else %}
        <button
          class="btn"
          type="button"
          onclick="getLocationAndSubmit()"
          id="submitBtn"
        >
          ğŸ“ ç«‹å³é»å
        </button>
        <p class="status-text" id="statusText" style="color: #ff3b30">
          âš ï¸ å°šæœªé»å
        </p>
        {% endif %}
      </form>

      <script>
        function getLocationAndSubmit() {
          var btn = document.getElementById("submitBtn");
          var status = document.getElementById("statusText");

          // 1. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡æŒ‰
          btn.disabled = true;
          btn.innerHTML = "ğŸ“¡ æ­£åœ¨å®šä½ä¸­...";
          btn.style.backgroundColor = "#8e8e93";

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                // 2. æˆåŠŸæŠ“åˆ°ä½ç½®
                document.getElementById("lat").value = position.coords.latitude;
                document.getElementById("lng").value =
                  position.coords.longitude;

                btn.innerHTML = "ğŸš€ é€å‡ºè³‡æ–™...";
                // 3. é€å‡ºè¡¨å–®
                document.getElementById("checkinForm").submit();
              },
              function (error) {
                // 4. å®šä½å¤±æ•—
                alert(
                  "å®šä½å¤±æ•—ï¼è«‹é–‹å•Ÿ GPS ä¸¦å…è¨±ç€è¦½å™¨è®€å–ä½ç½®ã€‚\néŒ¯èª¤ä»£ç¢¼: " +
                    error.code
                );
                btn.disabled = false;
                btn.innerHTML = "ğŸ“ ç«‹å³é»å";
                btn.style.backgroundColor = "#007aff";
              },
              {
                enableHighAccuracy: true, // è¦æ±‚é«˜ç²¾æº–åº¦
                timeout: 5000, // è¶…æ™‚ 5 ç§’
                maximumAge: 0, // ä¸ä½¿ç”¨å¿«å–
              }
            );
          } else {
            alert("æ‚¨çš„æ‰‹æ©Ÿä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
            btn.disabled = false;
          }
        }
      </script>
    </div>

    <div class="footer">
      å­¸è™Ÿ: {{ student['student_id'] }}<br />
      è£ç½®ç¶å®š ID: ...{{ request.args.get('token')[-4:] if
      request.args.get('token') else 'Cookie' }}
    </div>

    {% else %}
    <div class="card">
      <h1 style="color: #ff3b30">â›” ç„¡æ³•è­˜åˆ¥èº«åˆ†</h1>
      <p style="color: #666; line-height: 1.6">
        ç³»çµ±ç„¡æ³•ç¢ºèªæ‚¨çš„èº«åˆ†ã€‚<br /><br />
        è«‹ç¢ºèªæ‚¨æ˜¯å¾æ‰‹æ©Ÿæ¡Œé¢çš„<br />
        <strong>ã€Œå®¿èˆé»åã€APP åœ–ç¤º</strong><br />
        é€²å…¥ç³»çµ±ã€‚
      </p>
    </div>
    {% endif %}
  </body>
</html>
