<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>å®¿èˆæ™šé»å</title>

    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 20px;
        background-color: #f2f2f7;
        margin: 0;
      }
      .card {
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }
      h1 {
        color: #1c1c1e;
        margin-bottom: 5px;
        font-size: 1.8em;
      }
      .room {
        font-size: 2.5em;
        color: #007aff;
        font-weight: 800;
        margin: 10px 0;
        font-family: "SF Pro Display", sans-serif;
      }

      /* --- æ–°å¢ï¼šæ‹ç…§å€å¡Šæ¨£å¼ --- */
      .photo-upload-container {
        margin: 20px 0;
        padding: 15px;
        border: 2px dashed #c7c7cc;
        border-radius: 12px;
        background-color: #f9f9f9;
      }
      /* éš±è—åŸå§‹çš„ input file */
      input[type="file"] {
        display: none;
      }
      /* ç¾åŒ–æ‹ç…§æŒ‰éˆ• */
      .photo-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #e5e5ea;
        color: #007aff;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1em;
      }
      #photo-preview {
        display: none;
        width: 100%;
        max-width: 200px;
        margin-top: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      /* ----------------------- */

      .btn {
        display: block;
        width: 100%;
        padding: 18px;
        font-size: 1.2em;
        font-weight: bold;
        color: white;
        background-color: #007aff;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        margin-top: 20px;
        box-shadow: 0 4px 6px rgba(0, 122, 255, 0.3);
        transition: transform 0.1s ease;
      }
      .btn:active {
        transform: scale(0.96);
      }
      .btn:disabled {
        background-color: #34c759;
        box-shadow: none;
        cursor: default;
        transform: none;
      }
      .footer {
        margin-top: 30px;
        color: #8e8e93;
        font-size: 0.85em;
      }
      .status-text {
        margin-top: 15px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    {% if student %}
    <div class="card">
      <p
        style="
          color: #8e8e93;
          font-size: 0.9em;
          text-transform: uppercase;
          letter-spacing: 1px;
        "
      >
        æ™šé»åç³»çµ±
      </p>
      <div class="room">{{ student['room_number'] }}</div>
      <h1>{{ student['name'] }}</h1>

      <form method="POST" id="checkinForm" enctype="multipart/form-data">
        <input type="hidden" name="lat" id="lat" />
        <input type="hidden" name="lng" id="lng" />

        {% if error_msg %}
        <div
          style="
            background-color: #fff5f5;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
            font-size: 0.9em;
          "
        >
          {{ error_msg }}
        </div>
        {% endif %} {% if log and log['status'] == 'SUCCESS' %}
        <button class="btn" disabled>
          âœ… {{ log['checkin_time'].split(' ')[1][:5] }} å·²å®Œæˆ
        </button>
        <p class="status-text" style="color: #34c759">ä»Šæ—¥é»åæˆåŠŸ</p>

        {% else %}
        <div class="photo-upload-container">
          <p style="margin-bottom: 10px; color: #666">è«‹æ‹æ”ä¸€å¼µè‡ªæ‹ç…§</p>
          <label for="photo-input" class="photo-btn">ğŸ“· é»æ“Šæ‹ç…§</label>
          <input
            type="file"
            name="photo"
            id="photo-input"
            accept="image/*"
            capture="user"
            onchange="previewPhoto(this)"
          />
          <img id="photo-preview" src="#" alt="ç…§ç‰‡é è¦½" />
        </div>

        <button
          class="btn"
          type="button"
          onclick="getLocationAndSubmit()"
          id="submitBtn"
        >
          ğŸ“ é€å‡ºé»å (å«åº§æ¨™èˆ‡ç…§ç‰‡)
        </button>
        <p class="status-text" id="statusText" style="color: #ff3b30">
          âš ï¸ å°šæœªé»å
        </p>
        {% endif %}
      </form>
    </div>

    <div class="footer">å­¸è™Ÿ: {{ student['student_id'] }}</div>

    <script>
      // âœ… æ–°å¢ï¼šç…§ç‰‡é è¦½åŠŸèƒ½
      function previewPhoto(input) {
        var preview = document.getElementById("photo-preview");
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function getLocationAndSubmit() {
        var btn = document.getElementById("submitBtn");
        var photoInput = document.getElementById("photo-input");

        // âœ… æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦å·²æ‹ç…§
        if (photoInput.files.length === 0) {
          alert("è«‹å…ˆæ‹æ”è‡ªæ‹ç…§æ‰èƒ½é»åå–”ï¼");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = "ğŸ“¡ æ­£åœ¨å–å¾—ä½ç½®...";
        btn.style.backgroundColor = "#8e8e93";

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              document.getElementById("lat").value = position.coords.latitude;
              document.getElementById("lng").value = position.coords.longitude;

              btn.innerHTML = "ğŸš€ æ­£åœ¨ä¸Šå‚³è³‡æ–™èˆ‡ç…§ç‰‡...";
              // é€å‡ºè¡¨å–®
              document.getElementById("checkinForm").submit();
            },
            function (error) {
              var errorMsg = "å®šä½å¤±æ•—ï¼è«‹ç¢ºèª GPS å·²é–‹å•Ÿã€‚";
              if (error.code == 1) {
                errorMsg = "æ‚¨æ‹’çµ•äº†ä½ç½®å­˜å–ï¼Œç„¡æ³•é»åã€‚";
              } else if (error.code == 2) {
                errorMsg = "ç„¡æ³•åµæ¸¬åˆ°æ‚¨çš„ä½ç½®ï¼Œè«‹ç§»å‹•åˆ°ç©ºæ› è™•å†è©¦ã€‚";
              } else if (error.code == 3) {
                errorMsg = "å®šä½é€¾æ™‚ï¼Œè«‹é‡è©¦ã€‚";
              }

              alert(errorMsg);
              btn.disabled = false;
              btn.innerHTML = "ğŸ“ é€å‡ºé»å (å«åº§æ¨™èˆ‡ç…§ç‰‡)";
              btn.style.backgroundColor = "#007aff";
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        } else {
          alert("æ‚¨çš„æ‰‹æ©Ÿä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
          btn.disabled = false;
        }
      }
    </script>

    {% else %}
    <div class="card">
      <h1 style="color: #ff3b30">â›” ç„¡æ³•è­˜åˆ¥èº«åˆ†</h1>
      <p>è«‹å¾å°ˆå±¬é€£çµé€²å…¥ã€‚</p>
    </div>
    {% endif %}
  </body>
</html>
